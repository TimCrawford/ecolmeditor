<html>
<head>
	<meta http-equiv="content-type" content="text/html;charset=UTF-8" />
	<title>Electronic Corpus of Lute Music -- editors page</title>
<!-- <link type="text/css" rel="stylesheet" href="../webeditor.css" /> -->
	<link type="text/css" rel="stylesheet" href="../newlook.css" />
	<link type="text/css" rel="stylesheet" href="../render.css" />
	<link type="text/css" rel="stylesheet" href="../print.css" media="print" />
	<link type="text/css" rel="stylesheet" href="../features.css" />
	<link type="text/css" rel="stylesheet" href="three_pane.css" />
	<script src="../jquery-1.4.4.js" type="text/javascript"></script>
	
	<script src="../jquery.scrollTo-1.4.2-min.js" type="text/javascript"></script>
	<script type="text/javascript" src="../soundfont-player.js"></script>
	<script type="text/javascript" src="../dom.js"></script>
	<script type="text/javascript" src="../formatdate.js"></script>
	<script type="text/javascript" src="../user.js"></script>
	<script type="text/javascript" src="../php.js"></script>
	<script type="text/javascript" src="../diff.js"></script>
	<script type="text/javascript" src="../corebuttons.js"></script>
	<script type="text/javascript" src="../buttons.js"></script>
	<script type="text/javascript" src="../base.js"></script>
	<script type="text/javascript" src="../basic-drawing.js"></script>
	<script type="text/javascript" src="../tabclasses.js"></script>
	<script type="text/javascript" src="../parser.js"></script>
	<script type="text/javascript" src="../ornaments.js"></script>
	<script type="text/javascript" src="../ornament-buttons.js"></script>
	<script type="text/javascript" src="../rules.js"></script>
	<script type="text/javascript" src="../midi_mod_TC.js"></script>
	<script type="text/javascript" src="../editor.js"></script>
	<script src="../siamese/siamese.js"></script>
	<script type="text/javascript" src="test.js"></script>
	<script type="text/javascript" src="encode.js"></script>
	<script type="text/javascript" src="user.js"></script>
	<script type="text/javascript" src="distance.js"></script>
	<script type="text/javascript" src="../pianoroll-ajax.js"></script>
	<script type="text/javascript" src="../pianoroll.js"></script>
	<script type="text/javascript" src="../imgpreview.js"></script>

	<script type="text/javascript" src="importMIDI.js"></script>

<!-- slider stuff from http://loopj.com/jquery-simple-slider/ -->
	<script src="simple-slider.js"></script>
<!-- 
    <link href="simple-slider.css" rel="stylesheet" type="text/css" />         
    <link href="simple-slider-volume.css" rel="stylesheet" type="text/css" />  
 -->
<!-- 
	<script type="text/javascript" src="test.js">
 -->
	</script>
<!-- 	<script type="text/javascript" src="../features.js"></script> -->
	<script>
		function getEditorScroll() {
		  var elmnt = document.getElementById("editor_container");
		  oldTop = elmnt.scrollTop;
		}
	</script>

	<style type="text/css">
	  	#search_controls {
			border:1px solid black;
			padding:0.5px 0.5px 4px 0.5px;
	  	}
	  </style>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/pdfkit@0.10.0/js/pdfkit.standalone.js"></script>
<script type="text/javascript" src="https://bundle.run/blob-stream@0.1.3"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/svg-to-pdfkit@0.1.8/source.js"></script>

<!-- 
<script src="https://cdn.jsdelivr.net/npm/pdfkit@0.11.0/js/pdfkit.min.js"></script>
<script src="https://github.com/devongovett/blob-stream/releases/download/v0.1.3/blob-stream.js"></script>
<script src="https://cdn.jsdelivr.net/npm/svg-to-pdfkit@0.1.8/source.min.js"></script>
 -->

<!-- svg-exportJS prerequisite: canvg -->
<!-- <script src="https://unpkg.com/canvg@3.0.1/lib/umd.js"></script> -->
<script src="https://unpkg.com/deepmerge@3.3.0/dist/umd.js"></script>
<!-- svg-exportJS plugin -->
<script src="https://sharonchoong.github.io/svg-exportJS/svg-export.min.js"></script>
<!-- <script src="svg-export.js"></script> -->

<script>
// Function to export SVG to PDF using the two JS libraries above from: https://morioh.com/p/287697cc17da
function export_SVG_as_PDF() {
	var filename = prompt("Export filename:", "tablature");
	if (filename != null) {

		svgExport.downloadPdf(document.getElementById("notation"),filename, { 
               pdfOptions: {
                    customFonts: [
//                      { url: "../pdf_fonts/tabfontwebfont.ttf", fontName: "TabRegular" },
//                      { url: "../pdf_fonts/varietie4webfont.ttf", fontName: "Varietie3Rhythms" },
//                      { fontName: "Varietie3", url: "../pdf_fonts/varietiefretsornswebfont.ttf"},
                     { url: "../pdf_fonts/varietie4webfont.ttf", fontName: "Varietie3" },
//                      { url: "../pdf_fonts/varietie4webfont.ttf", fontName: "Varietie3FretsAndOrns" },
//                      { url: "../pdf_fonts/varietie4webfont.ttf ", fontName: "Varietie3-ts" }

// FIXME Still need to rename TabFont/Weiss for baroque tab

                    ]
               },
                useCSS: true
		} 
     )
  }
}
function export_SVG_as_JPG() {
	var filename = prompt("Export filename:", "tablature");
	if (filename != null) {
//   	downloadPDF(document.getElementById("notation"),filename)
		svgExport.downloadJpeg(document.getElementById("notation"),filename, { 
			useCSS: true
		} 
     )
  }
}
function export_SVG_as_PNG() {
	var filename = prompt("Export filename:", "tablature");
	if (filename != null) {
//   	downloadPDF(document.getElementById("notation"),filename)
		svgExport.downloadPng(document.getElementById("notation"),filename, { 
			useCSS: true
		} 
     )
  }
}
function export_SVG_as_SVG() {
	var filename = prompt("Export filename:", "tablature");
	if (filename != null) {
//   	downloadPDF(document.getElementById("notation"),filename)
		svgExport.downloadSvg(document.getElementById("notation"),filename, { 
			useCSS: true
		} 
     )
  }
}

// gJustify = 0;
// function JustifySystems() {
// 	gJustify = 10;
// 	TabCodeDocument.draw();
// 	refresh();
// }

</script>	  
	  
	  
</head>
<body onload="javascript:initialiseTestPage(urlParams); refresh2(); tcHide();">
<!-- 
<body onload="javascript:initialiseTestPage(true);">
 -->
<div id="top_fixed_container">
	<div id="banner">
		<div class="logo_centre">
			<img src="../full_ECOLM_logo.gif" height="100px" alt="Electronic Corpus of Lute Music" />
		</div>
	</div>
	<div id="menubar" class="clear">
		<div class="left" id="editbuttons">
			<button class="reditbutton" id="undobutton" onclick="javascript:TabCodeDocument.parameters.history.undo();">Undo</button> <button class="reditbutton" id="redobutton" onclick="javascript:TabCodeDocument.parameters.history.redo();">Redo</button> <button class="reditbutton" id="revertbutton" onclick="javascript:revert();">Revert</button><br/><button   class="reditbutton" id="revertbutton" onclick="javascript:tidy_rhythms();">Tidy Rhythms</button>  <button  class="reditbutton" id="revertbutton" onclick="javascript:augment_rhythms();">Rss x 2</button>  <button  class="reditbutton" id="revertbutton" onclick="javascript:diminish_rhythms();">Rss / 2</button> 
		</div>
		<div class="widerright" id="playback">
			<button onclick="javascript:  playOrResume(); ">Play</button> 
			<button onclick="javascript:  stopOrPause(); ">Stop</button> 
			<select id="soundSelect">
				<option value="G_lute" selected>G lute</option>
				<option value="E_lute">E lute</option>
				<option value="Bar_lute">D minor lute (A=415Hz)</option>
			</select>
			<small> 
				<label class="tempo">Tempo: 
				<input id="tempoSlider" type="range" min="30" max="480" value="240" onchange="showTempoValue(this.value);" onload="showTempoValue(this.value);" onmouseup="updateTempo();" />
				</label> 
				<div class="editbutton" id='tempoReadOut'>
					<span id='tempoReadOutvalue'></span> bpm
				</div>
			</small> 
			<br/>
<!-- 
			<span id="search_controls"> 
				<select id="CorpusSelection">
					<option value="ecolm">ECOLM</option>
					<option value="gerbode" selected>Gerbode incipits</option>
				</select>
				<button disabled onclick="javascript: corpusSearch();">Search</button> 
		<!~~          <button  onclick="javascript: corpusSearch();">Search</button> ~~>
			</span> 
 -->
		</div>
	</div>
	<div id="settingsbar" class="clear" style="height: 48px">
		<div class="left">
			<button class="reditbutton" id="switchTabType" onclick="toggleTabType(this)">Tab: Italian</button> 
			<button class="reditbutton" id="switchTabFont" onclick="toggleFont(this)">Font: Italian</button> 
			<button class="editbutton" id="switchTuning" onclick="rotateTuning(this)">Renaissance G</button> 
		</div>
<!-- 		<span class="right" id="barnum_highlight" class="clear"> -->
		<div style="height: 12px; ">
			<span  id="barnum_highlight" class="clear">
				<span class="barNumChoiceLabel"><small>Bar number display:</small></span> 
				<select id="BarnumberDisplay"  onchange="SetBarNumDisplay(this.value);">
					<option value="none" selected>None</option>
					<option value="systems">Every system</option>
					<option value="five_bars">Every five bars</option>
					<option value="all_bars">Every bar</option>
				</select>
			<span id="print_controls" class="clear">
				<small>Export as: </small><button  onclick="export_SVG_as_PDF()"><small>PDF</small></button>
				&nbsp;&nbsp;&nbsp;
				<label  for="on_line_check"><small>Letters on lines</small></label>
				<input type="checkbox" id="on_line_check" onchange="refresh()">
			</span>
		</div>
		<br>
		<span id="rhythm-sign_controls" overflow: hidden;>
			<span style="border:1px solid black;padding:2px">
				<label  for="upbeat"><small>Upbeat?</small></label>
				<input   type="checkbox" id="upbeat_checkbox" name="upbeat" onchange="SetBarNumDisplay();SetgStartTime();">
			</span>
			<span style="border:1px solid black;padding:2px">
				<label  for="upbeat"><small>Crotchet: <img id="q_flag" src="flag_Q.jpg" height="14px"></small></label>
				<input   type="checkbox" id="reduction_checkbox" name="upbeat" onchange="toggleDoubleDurs()">
			</span>
<script>
	var DoubleDurs = false;
	function toggleDoubleDurs() {
		if(DoubleDurs) DoubleDurs=false;
		else DoubleDurs = true;
		document.getElementById("q_flag").src= (DoubleDurs)? "flag_E.jpg" : "flag_Q.jpg";
		refresh();
		logger.log("DoubleDurs "+DoubleDurs+ " src: "+document.getElementById("q_flag").src)
	}
</script>

			<span style="border:1px solid black;padding:2px">
				<small>Colour beats every:</small>
				<label  for="doublebeat_check"><span class="doublebeat"><small>1024</small></span></label>
				<input   type="checkbox" id="doublebeat_check" name="mainbeat" onchange="refresh()">&nbsp;&nbsp;
				<label  for="mainbeat_check"><span class="mainbeat"><small>512</small></span></label>
				<input   type="checkbox" id="mainbeat_check" name="mainbeat" onchange="refresh()">&nbsp;&nbsp;
				<label  for="secondarybeat_check"><span class="secondarybeat" ><small>256</small></span></label>
				<input   type="checkbox" id="secondarybeat_check" name="mainbeat" onchange="refresh()" >&nbsp;&nbsp;
				<label  for="tertiarybeat_check"><span class="tertiarybeat"><small>128</small></span></label>
				<input   type="checkbox" id="tertiarybeat_check" name="tertiarybeat" onchange="refresh()" >&nbsp;&nbsp;
				<label  for="quaternarybeat_check"><span class="quaternarybeat"><small>64</small></span></label>
				<input   type="checkbox" id="quaternarybeat_check" name="quaternarybeat" onchange="refresh()" >&nbsp;&nbsp;
				<label  for="mainbeat_dot_check"><span class="mainbeat_dot"><small>768</small></span></label>
				<input   type="checkbox" id="mainbeat_dot_check" name="mainbeat_dot" onchange="refresh()" >&nbsp;&nbsp;
				<label  for="secondarybeat_dot_check"><span class="secondarybeat_dot"><small>384</small></span></label>						
				<input   type="checkbox" id="secondarybeat_dot_check" name="secondarybeat_dot" onchange="refresh()">&nbsp;&nbsp;
				<label  for="tertiarybeat_dot_check"><span class="tertiarybeat_dot"><small>192</small></span></label>
				<input   type="checkbox" id="tertiarybeat_dot_check" name="tertiarybeat_dot" onchange="refresh()" >&nbsp;&nbsp;
				<label  for="quaternarybeat_dot_check"><span class="quaternarybeat_dot"><small>96</small></span></label>
				<input   type="checkbox" id="quaternarybeat_dot_check" name="quaternarybeat_dot" onchange="refresh()" >
			</span>
			</span> <!-- End of span "rhythm-sign_controls" -->

	<!-- 
		<button disabled id="justify_button" onclick="JustifySystems()">
				Justify
			</button>
		</span>
		<span width="24px" class="spacer">&nbsp;&nbsp;&nbsp;</span>
 -->		

<!-- 
		<span id="chord_hlite_controls">
			<label for="chord">Highlight chords:</label> 
			<input style="width:60px" type="text" id="chord" name="chord" /> 
			<input style="width:60px" type="text" id="chord_sel_end" name="chord_sel_end" /> 
			<input style="width:20px" type="text" id="ng_len" name="ng_len" /> 
			<input type="button" value="Go" onclick="goto()"/> 
		</span>
 -->
	</div>
</div>

<!-- 
<div id="editor_container" class="editor_left" style="bottom: 0; margin-left: 15px; margin-right: 15px; margin-bottom: 15px; width: 1000px;top: 270px; position: fixed; y-overflow: auto; overflow-x: scroll;" onscroll="getEditorScroll()">
 -->
<div id="editor_container" class="editor_left" style="bottom: 0; margin-left: 15px; margin-right: 15px; margin-bottom: 15px; width: 1200px; position: relative; y-overflow: scroll; overflow-x: scroll;" onscroll="getEditorScroll()">
	<div id="editor">
		<div id="rendered" class="notation">
			<svg class="rendered" id="notation" width="900px"  ></svg> 
		</div>
	</div>
</div>
<div id="resultTab" class="hasControls">
</div>
<div id="code_container" style="width: 30%; position: fixed; top: 18px; left: 75%">
	<div id="codediv" >
		<button id="choose_tcfile" onclick="displayTabCodeFromTCFile()">Import TabCode</button>
		<span id="tcchooser" hidden>
			<input type="file" id="TCfiletoRead" class="tc-file-input" />
		</span>
		<br>
		<button id="choose_midifile" onclick="displayTabCodeFromMIDIFile()">Import MIDI</button>
		<span id="midichooser" hidden>
			<input type="file" id="MIDIfiletoRead" class="midi-file-input" /> 
		</span>
		<script>
		
		// Some time soon, switch to using the following for read/save of local (CLIENT) files!!!
// 		// 		from https://web.dev/browser-fs-access/
// 		// The imported methods will use the File
// 		// System Access API or a fallback implementation.
// 		import {
// 		  fileOpen,
// 		  directoryOpen,
// 		  fileSave,
// 		} from 'https://unpkg.com/browser-fs-access';

readSyncDataURL = function(file) {
//    var url = URL.createObjectURL(file); //Create Object URL
    var url =file;
    var xhr = new XMLHttpRequest();
    xhr.open("GET", url, false); //Synchronous XMLHttpRequest on Object URL
    xhr.overrideMimeType("text/plain; charset=x-user-defined"); //Override MIME Type to prevent UTF-8 related errors
    xhr.send();
    URL.revokeObjectURL(url);
    var returnText = "";
    for (var i = 0; i < xhr.responseText.length; i++) {
      returnText += String.fromCharCode(xhr.responseText.charCodeAt(i) & 0xff);
    }; //remove higher byte
//    return "data:" + file.type + ";base64," + btoa(returnText); //Generate data URL
    if(xhr.status == 200) return returnText;
    }



			async function getTabCode(url) {
// 			  const request = await $.get(url)  
// 			  return request;
			result = await readSyncDataURL(url);
// 			  logger.log(result)
			return result;
			}

		async  function displayTabCodeFromURL() {
				  var tcfile = urlParams.get("tc_path");
				  var name = tcfile.substr(tcfile.lastIndexOf("/")+1);
				  if (tcfile) {
					 if(name.substring(name.length-3,name.length)==".tc") {
						await $.get(tcfile,function(data) {
							if (data.length) {
								 $(document.getElementById('tcshow')).show();
								 logger.log(data)
								 $('#code_container').css('display', 'initial');
								 document.getElementById("code").value = data;
								 gJustify=0;
								 logger.log(document.getElementById("code").value)
								 refreshFromTabCode();
							} 
							else {
								alert("Nothing in file "+tcfile+" !!");
							}
						});

/*
					    getTabCode(tcfile)
						.then ((data) => {
							console.log(data)
							if (data.length) {
								 $(document.getElementById('tcshow')).show();
								 $('#code_container').css('display', 'initial');
								 document.getElementById("code").value = data;
								 gJustify=0;
								 refreshFromTabCode();
								 $(document.getElementById('tcshow')).show();
							} 
							else {
								alert("Nothing in file "+tcfile+" !!");
							}})
*/
							
					}
					else alert("Not a TabCode file! Please try again!")
				    }
// 				},false);
			}
			
		  function displayTabCodeFromTCFile() {
			document.getElementById('choose_tcfile').hidden=true;
			document.getElementById('tcchooser').hidden=false;
			document.getElementById('midichooser').hidden=true;
			document.getElementById('choose_midifile').hidden=false;
			document.getElementById("TCfiletoRead").addEventListener("change",function(){
				  var tcfile = this.files[0];
				  var name = tcfile.name;
				  if (tcfile) {
					 if(name.substring(name.length-3,name.length)==".tc") {
						 var reader = new FileReader();
						 reader.onload = function (evt) {
						   document.getElementById("code").value = evt.target.result;
						 };
						 reader.onerror = function (evt) {
						   logger.error("An error ocurred reading the file",evt);
						 };
						 reader.readAsText(tcfile, "UTF-8");
						 gJustify=0;
						 refreshFromTabCode();
						 $(document.getElementById('tcshow')).show();
					    }
					else alert("Not a TabCode file! Please try again!")
				    }
				},false);
			}
			
		  function displayTabCodeFromMIDIFile() {
			document.getElementById('choose_midifile').hidden=true;
			document.getElementById('midichooser').hidden=false;	
			document.getElementById('tcchooser').hidden=true;	
			document.getElementById('choose_tcfile').hidden=false;
			document.getElementById("MIDIfiletoRead").addEventListener("change",function(){
				  var midifile = this.files[0];
				  var name = midifile.name;
				  if (midifile) {
					 logger.log("File is "+name)
					 if(name.substring(name.length-4,name.length)==".mid") {
// 					 	var reader = new FileReader();
// 						 reader.onload = function (evt) {
// 						 logger.log(evt);
 						 theTabCode = get_and_convert_MIDI(tempPath(midifile),name,setAndRedrawTabcodeFun); // user might want to change name
//						 var theTabCode = get_and_convert_MIDI(midifile,name); // user might want to change name
						 logger.log(theTabCode)
// 						 document.getElementById("code").value = theTabCode;
// // 						 };
// // 						 reader.onerror = function (evt) {
// // 						   logger.error("An error ocurred reading the file",evt);
// // 						 };
// 						 gJustify=0;
// 						 refreshFromTabCode();
// 						 $(document.getElementById('tcshow')).show();
					    }
					else alert(name+" is not a MIDI file! Please try again!")
				    }
				},false);
			}
		</script>

		<br>
		<button id="tcshow" onclick="tcShow();" style="display:none">Show TabCode </button> 
		<button id="tchide" onclick="tcHide();"  style="display:none">Hide TabCode</button> 
		<div id="tcspan">
<!-- 
			Tabcode for this piece:<br />
 -->
			<textarea style=" height:400px; width:250px; resize: both" rows="6" cols="68" id="code" onkeyup="if(!TabCodeDocument || TabCodeDocument.code != this.value){ refreshFromTabCode();}"></textarea>
			<br>
			<button id="tcdownload" onclick="download();">Download TabCode </button> 
		</div>

<script>

	// from: https://robkendal.co.uk/blog/2020-04-17-saving-text-to-client-side-file-using-vanilla-js
	function download() {
		const downloadToFile = (content, filename, contentType) => {
			const a = document.createElement('a');
			const file = new Blob([content], {type: contentType});
			a.href= URL.createObjectURL(file);
			a.download = filename;
			a.click();
			URL.revokeObjectURL(a.href);
		};
// 		document.querySelector('#tcdownload').addEventListener('click', () => {
			const textArea = document.getElementById('code');
			var new_filename = prompt("New filename", "tabcode.tc");
			if (new_filename != null) {
				downloadToFile(textArea.value, new_filename, 'text/plain');
  			}
  			else {
  				alert("No filename given! Try Again!");
  			}		
// 		});
	}
</script>

			<br />
		</div>
	</div>
</div>
<div class="searchResults" id="searchResults">
</div>
<div class="lamp lampsaved" id="statuslamp">
</div>
<div id="debug_mess">
</div>
 
 <script>
 	
 	beat_boxes = [
 		{check:"doublebeat_check",value:1024},
		{check:"mainbeat_check",value:512},
		{check:"secondarybeat_check",value:256},
		{check:"tertiarybeat_check",value:128},
		{check:"quaternarybeat_check",value:64},
		{check:"mainbeat_dot_check",value:768},
		{check:"secondarybeat_dot_check",value:384},
		{check:"tertiarybeat_dot_check",value:192},
		{check:"quaternarybeat_dot_check",value:96}
	];
	function getBeatBox(val) {
		for(i=0;i<beat_boxes.length;i++) {
			if(beat_boxes[i].value == val) return beat_boxes[i].check;
		}
		return false;
	}
 	
 	const urlParams = new URLSearchParams(window.location.search);
 	var hide_systembreaks = false; // we will hide them for TabCode display version

// check if this is just the TabCode display version:
 	if(urlParams.has("tc_path")) {
//  		logger.log(urlParams.get("tc_path"));

 		// Add new CSS to hide non-essential bits:
 		$(document).ready(function () {$('#banner').css('display', 'none');});
 		$(document).ready(function () {$('#editbuttons').css('display', 'none');});
//  		$(document).ready(function () {$('#rhythm-sign_controls').css('display', 'none');});
  		$(document).ready(function () {$('#choose_tcfile').css('display', 'none');});
  		$(document).ready(function () {$('#tcchooser').css('display', 'none');});
  		$(document).ready(function () {$('#midichooser').css('display', 'none');});
  		$(document).ready(function () {$('#choose_midifile').css('display', 'none');});
  		$(document).ready(function () {$('#switchTabType').css('display', 'none');});
  		$(document).ready(function () {$('#switchTabFont').css('display', 'none');});
  		$(document).ready(function () {$('#switchTuning').css('display', 'none');});
		hide_systembreaks = true;
		
 		// Load contents of tc.path into code text-box
 		displayTabCodeFromURL();

		// Highlight beats for search-window
		if(urlParams.has("window")) {
			document.getElementById(getBeatBox(urlParams.get("window"))).click();
		}		

		// Hide TabCode
// 		document.getElementById("tchide").click();
		tcHide();
 	}
 
	
 </script>


</body>
</html>
